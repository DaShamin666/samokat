name: ðŸ§ª Automated Testing

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]
  workflow_dispatch: # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

env:
  PYTHON_VERSION: '3.12'
  PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/ms-playwright

jobs:
  # Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ smoke Ñ‚ÐµÑÑ‚Ð°Ð¼Ð¸
  smoke-tests:
    name: ðŸ”¥ Smoke Tests (Quick Check)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install playwright pytest pytest-playwright allure-pytest faker
        
    - name: ðŸŽ­ Install Playwright browsers and system dependencies
      run: |
        playwright install-deps chromium
        playwright install chromium
        
    - name: ðŸ”¥ Run Smoke Tests
      run: |
        python -m pytest -m smoke -v --tb=short --maxfail=3
        
    - name: ðŸ“Š Upload test results (if failed)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: smoke-test-results
        path: |
          screenshots/
          videos/
        retention-days: 7

  # ÐŸÐ¾Ð»Ð½Ñ‹Ðµ Ñ€ÐµÐ³Ñ€ÐµÑÑÐ¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹
  regression-tests:
    name: ðŸ”„ Regression Tests (Full Suite)
    runs-on: ubuntu-latest
    needs: smoke-tests # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ smoke Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸
    timeout-minutes: 30
    
    strategy:
      fail-fast: false # ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð¾Ð´Ð¸Ð½ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€ ÑƒÐ¿Ð°Ð»
      matrix:
        browser: [chromium, firefox, webkit]
        
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install playwright pytest pytest-playwright allure-pytest faker
        
    - name: ðŸŽ­ Install Playwright browsers and system dependencies
      run: |
        playwright install-deps ${{ matrix.browser }}
        playwright install ${{ matrix.browser }}
        
    - name: ðŸ”„ Run Regression Tests  
      run: |
        python -m pytest -m regression --browser=${{ matrix.browser }} -v --tb=short -k "not (test_complete_order_path or test_metro_stations or test_rental_periods or test_first_step_completion or test_multiple_orders or test_predefined_users or test_same_data_different_buttons or test_complete_order_flow or test_fill_order_form_step1_random_user)"
      env:
        BROWSER: ${{ matrix.browser }}
        
    - name: ðŸ“Š Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: regression-test-results-${{ matrix.browser }}
        path: |
          screenshots/
          videos/
          test-results/
        retention-days: 7

  # Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
  full-test-suite:
    name: ðŸŽ¯ Full Test Suite (All Tests)
    runs-on: ubuntu-latest
    needs: [smoke-tests, regression-tests]
    if: github.event_name == 'pull_request' # Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ PR
    timeout-minutes: 45
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install playwright pytest pytest-playwright allure-pytest faker
        
    - name: ðŸŽ­ Install Playwright browsers and system dependencies
      run: |
        playwright install-deps
        playwright install chromium firefox webkit
        
    - name: ðŸŽ¯ Run All Tests
      run: |
        python -m pytest -v --tb=short --durations=10 --browser=chromium -k "not (test_complete_order_path or test_metro_stations or test_rental_periods or test_first_step_completion or test_multiple_orders or test_predefined_users or test_same_data_different_buttons or test_complete_order_flow or test_fill_order_form_step1_random_user)"
        
    - name: ðŸ“ˆ Generate Allure Report
      if: always()
      run: |
        pip install allure-pytest
        python -m pytest --alluredir=allure-results -v --tb=short --browser=chromium -k "not (test_complete_order_path or test_metro_stations or test_rental_periods or test_first_step_completion or test_multiple_orders or test_predefined_users or test_same_data_different_buttons or test_complete_order_flow or test_fill_order_form_step1_random_user)" || true
        
    - name: ðŸ“Š Upload Allure Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results
        path: allure-results/
        retention-days: 14
        
    - name: ðŸ“· Upload Screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: failed-test-screenshots
        path: |
          screenshots/
          videos/
        retention-days: 14

  # ÐÐ½Ð°Ð»Ð¸Ð· Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¸ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹
  test-summary:
    name: ðŸ“‹ Test Results Summary
    runs-on: ubuntu-latest
    needs: [smoke-tests, regression-tests, full-test-suite]
    if: always() # Ð’ÑÐµÐ³Ð´Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ñ‚ÐµÑÑ‚Ñ‹ ÑƒÐ¿Ð°Ð»Ð¸
    
    steps:
    - name: ðŸ“Š Create Test Summary
      run: |
        echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.smoke-tests.result }}" == "success" ]; then
          echo "âœ… **Smoke Tests**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Smoke Tests**: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.regression-tests.result }}" == "success" ]; then
          echo "âœ… **Regression Tests**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Regression Tests**: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.full-test-suite.result }}" == "success" ]; then
          echo "âœ… **Full Test Suite**: PASSED" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.full-test-suite.result }}" == "skipped" ]; then
          echo "â­ï¸ **Full Test Suite**: SKIPPED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Full Test Suite**: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Test Statistics:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”¥ Smoke Tests: 9 tests" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”„ Regression Tests: 39 tests" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¯ Total Tests: 65 tests" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ­ Tested Browsers:" >> $GITHUB_STEP_SUMMARY
        echo "- Chromium âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- Firefox âœ…" >> $GITHUB_STEP_SUMMARY  
        echo "- WebKit âœ…" >> $GITHUB_STEP_SUMMARY
